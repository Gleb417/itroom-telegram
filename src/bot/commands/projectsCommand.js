import { InlineKeyboard } from "grammy";
import {
  getRepositories,
  getProjectsV2,
  getTasks,
  getTaskDetails,
} from "../../services/githubService.js";
import db from "../../db/models/index.js";

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ²
export async function projectsCommand(ctx) {
  console.log("ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /project Ð²Ñ‹Ð·Ð²Ð°Ð½Ð°");
  const chatId = ctx.chat.id;

  try {
    const user = await db.User.findOne({ where: { telegram_id: chatId } });
    if (!user || !user.github_token) {
      console.log("ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½");
      return ctx.reply(
        "Ð’Ñ‹ Ð½Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ñ‹. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ /auth Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸."
      );
    }

    const userToken = user.github_token;
    const repositories = await getRepositories(userToken);

    if (!repositories.length) {
      return ctx.reply("Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ².");
    }

    const keyboard = new InlineKeyboard();
    repositories.forEach((repo) => {
      keyboard.text(repo.name, `repo_${repo.id}`).row();
    });

    await ctx.reply("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹:", { reply_markup: keyboard });
  } catch (error) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð² projectsCommand:", error.message);
    ctx.reply("ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.");
  }
}

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° inline-Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² (Ð²Ñ‹Ð±Ð¾Ñ€ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ, Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð¸ Ð·Ð°Ð´Ð°Ñ‡Ð¸)
// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° (Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð·Ð°Ð´Ð°Ñ‡)
export async function handleInlineQuery(ctx) {
  const action = ctx.callbackQuery.data;

  try {
    const chatId = ctx.chat.id;
    const user = await db.User.findOne({ where: { telegram_id: chatId } });

    if (!user || !user.github_token) {
      await ctx.answerCallbackQuery();
      return ctx.reply(
        "Ð’Ñ‹ Ð½Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ñ‹. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ /auth Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸."
      );
    }

    const userToken = user.github_token;

    // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
    if (action.startsWith("repo_")) {
      const repoId = action.split("_")[1];
      const repositories = await getRepositories(userToken);
      const selectedRepo = repositories.find(
        (repo) => String(repo.id) === repoId
      );

      if (!selectedRepo) {
        console.error("Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. repoId:", repoId);
        await ctx.answerCallbackQuery();
        return ctx.reply("Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.");
      }

      const projects = await getProjectsV2(
        userToken,
        selectedRepo.owner.login,
        selectedRepo.name
      );

      if (!projects.length) {
        await ctx.answerCallbackQuery();
        return ctx.reply("Ð’ ÑÑ‚Ð¾Ð¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸ Ð½ÐµÑ‚ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð².");
      }

      const keyboard = new InlineKeyboard();
      projects.forEach((project) => {
        keyboard.text(project.title, `project_${project.id}_${repoId}`).row();
      });

      await ctx.answerCallbackQuery();
      return ctx.reply("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚:", { reply_markup: keyboard });
    }

    // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° (Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð·Ð°Ð´Ð°Ñ‡)
    if (action.startsWith("project_")) {
      const lastUnderscoreIndex = action.lastIndexOf("_");
      const projectId = action.slice(8, lastUnderscoreIndex); // "project_" (8 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²)
      const repoId = action.slice(lastUnderscoreIndex + 1);

      const repositories = await getRepositories(userToken);
      const selectedRepo = repositories.find(
        (repo) => String(repo.id) === repoId
      );

      if (!selectedRepo) {
        console.error("Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. repoId:", repoId);
        await ctx.answerCallbackQuery();
        return ctx.reply("Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.");
      }

      const tasks = await getTasks(userToken, projectId);
      console.log("ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸:", tasks);

      if (!tasks.length) {
        return ctx.reply("Ð’ ÑÑ‚Ð¾Ð¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ Ð½ÐµÑ‚ Ð·Ð°Ð´Ð°Ñ‡.");
      }

      // Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÐµ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð¿ÐµÑ€ÐµÐ´ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸ÐµÐ¹
      tasks.forEach((task) => {
        console.log(
          "Ð—Ð°Ð´Ð°Ñ‡Ð° Ð¿ÐµÑ€ÐµÐ´ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸ÐµÐ¹:",
          task.title,
          task.content?.assignees
        );
      });

      // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ð¾ ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ð·Ð°Ð´Ð°Ñ‡Ðµ (Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹)
      const tasksWithDetails = await Promise.all(
        tasks.map(async (task) => {
          const taskDetails = await getTaskDetails(userToken, task.id);
          return { ...task, details: taskDetails }; // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ÑÑ‚Ð¸ Ð·Ð°Ð´Ð°Ñ‡Ð¸
        })
      );
      console.log(tasksWithDetails);

      // Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð¿Ð¾ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð½Ð¾Ð¼Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
      const assignedTasks = tasksWithDetails.filter((task) => {
        const assigneesString = task.details?.assignee; // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÑ‚Ñ€Ð¾ÐºÑƒ Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÐµÐ¹
        if (!assigneesString) return false; // Ð•ÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»Ð¸ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚, Ð·Ð°Ð´Ð°Ñ‡Ð° Ð¸ÑÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ÑÑ

        // ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ ÑÑ‚Ñ€Ð¾ÐºÑƒ Ð² Ð¼Ð°ÑÑÐ¸Ð² Ð»Ð¾Ð³Ð¸Ð½Ð¾Ð²
        const assignees = assigneesString
          .split(",")
          .map((assignee) => assignee.trim());

        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÑ€ÐµÐ´Ð¸ Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÐµÐ¹
        return assignees.includes(user.github_username);
      });

      // Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð¿Ð¾ÑÐ»Ðµ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸
      console.log(
        "Ð—Ð°Ð´Ð°Ñ‡Ð¸ Ð¿Ð¾ÑÐ»Ðµ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð½Ð¾Ð¼Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ:",
        assignedTasks
      );

      if (assignedTasks.length === 0) {
        return ctx.reply("Ð’Ñ‹ Ð½Ðµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ñ‹ Ð½Ð° Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð² ÑÑ‚Ð¾Ð¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ.");
      }

      const keyboard = new InlineKeyboard();
      assignedTasks.forEach((task) => {
        const taskText = task.title || "Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ"; // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ
        keyboard.text(taskText, `task_${task.id}`).row();
      });

      return ctx.reply("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð·Ð°Ð´Ð°Ñ‡Ñƒ:", { reply_markup: keyboard });
    }

    // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð·Ð°Ð´Ð°Ñ‡Ð¸ (Ð¿Ð¾ÐºÐ°Ð· Ð²ÑÐµÐ¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð·Ð°Ð´Ð°Ñ‡Ðµ)
    if (action.startsWith("task_")) {
      const taskId = action.split("_").slice(1).join("_"); // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ taskId
      console.log("ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð½Ñ‹Ð¹ taskId:", taskId);

      const task = await getTaskDetails(userToken, taskId);

      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÐ»Ð¸ Ð·Ð°Ð´Ð°Ñ‡Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð¸Ð»Ð¸ Ð² Ð¾Ñ‚Ð²ÐµÑ‚Ðµ Ð½ÐµÑ‚ Ð½ÑƒÐ¶Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
      if (!task) {
        await ctx.answerCallbackQuery();
        return ctx.reply(
          "Ð—Ð°Ð´Ð°Ñ‡Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð¸Ð»Ð¸ Ð¸Ð¼ÐµÐµÑ‚ Ð½ÐµÐ²ÐµÑ€Ð½ÑƒÑŽ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…."
        );
      }

      const taskDetails = `
ðŸ“‹ *Ð—Ð°Ð´Ð°Ñ‡Ð°*: ${escapeMarkdown(task.title)}

ðŸ“ *ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ*: ${escapeMarkdown(task.body || "ÐÐµÑ‚ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ")}

ðŸ”— *Ð¡ÑÑ‹Ð»ÐºÐ°*: [ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ñƒ](${task.url})

ðŸ•’ *Ð¡Ð¾Ð·Ð´Ð°Ð½Ð°*: ${escapeMarkdown(new Date(task.createdAt).toLocaleString())}
ðŸ”„ *ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°*: ${escapeMarkdown(new Date(task.updatedAt).toLocaleString())}

ðŸ‘¤ *ÐžÑ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹*: ${escapeMarkdown(task.assignee || "ÐÐµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½")}
`;

      // ÐšÐ½Ð¾Ð¿ÐºÐ° Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÐµÐ²
      console.log("ÐÐ™Ð´Ð¸ Ð·Ð°Ð´Ð°Ñ‡Ð¸:", taskId);
      const keyboard = new InlineKeyboard().text(
        "ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸",
        `show_comments_${taskId}`
      );

      await ctx.answerCallbackQuery();
      return ctx.reply(taskDetails, {
        parse_mode: "MarkdownV2",
        reply_markup: keyboard,
      });
    }
  } catch (error) {
    console.error(
      "ÐžÑˆÐ¸Ð±ÐºÐ° Ð² handleInlineQuery:",
      error.response?.data || error.message
    );
    await ctx.answerCallbackQuery();
    ctx.reply("ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.");
  }
}

// Ð­ÐºÑ€Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Markdown
function escapeMarkdown(text) {
  return text.replace(/([_\*\[\]()~`>#+\-=|{}.!-])/g, "\\$1");
}
